#!/usr/bin/env bash
set -euo pipefail

file=$@

sbom_folder=sboms

if [ ! -d $sbom_folder ]; then
  mkdir $sbom_folder
fi

jq -c '.[]' "$file" | while IFS= read -r item; do

  image=$(echo $item | jq -r '.image')
  tag=$(echo $item | jq -r '.tag')
  repo_file="${image#registry.redhat.io/openshift4/}_$tag"
  repo_file="${repo_file#registry.redhat.io/openshift4-wincw/}"
  repo_file="${repo_file#/_}.json"
  if [ ! -f $sbom_folder/$repo_file ]; then
    echo "Pulling image $image:$tag and generating SBOM file: $repo_file"
    podman pull $image:$tag --arch amd64; syft $image:$tag --scope all-layers -o cyclonedx-json -q | jq . > $sbom_folder/$repo_file

    echo "Clean up image $image:$tag"
    podman rmi $image:$tag
  fi
done